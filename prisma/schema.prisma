generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  String               @id @default(cuid())
  email               String               @unique
  password            String
  name                String
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  age                 Int?
  bmi                 Float?
  gender              Gender?
  height              Float?
  preferredName       String?
  sleepHours          Float?
  targetWeight        Float?
  trainingDaysPerWeek Int?
  trainingEnvironment ExerciseEnvironment? @default(GYM)
  trainingLevel       ExperienceLevel?
  waterDaily          Float?
  weight              Float?
  workoutDays         DayOfWeek[]
  lastActiveAt        DateTime?
  longestStreak       Int                  @default(0)
  streakCount         Int                  @default(0)
  totalActiveHours    Float                @default(0)
  dailyActivities     DailyActivity[]
  userAdaptiveStates  UserAdaptiveState[]
  plans               UserPlan[]
  userSessions        UserSession[]
  trainingProfile     UserTrainingProfile?

  @@index([email])
  @@map("users")
}

model UserPlan {
  id              String           @id @default(cuid())
  userId          String
  planJson        Json
  startDate       DateTime
  endDate         DateTime?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  previousPlanId  String?          @unique
  volumeOverrides Json?
  blockEvaluation BlockEvaluation?
  previousPlan    UserPlan?        @relation("PlanHistory", fields: [previousPlanId], references: [id])
  nextPlan        UserPlan?        @relation("PlanHistory")
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  sessions        UserSession[]

  @@index([userId])
  @@map("user_plans")
}

model UserSession {
  id               String            @id @default(cuid())
  userId           String
  planId           String
  dayNumber        Int
  week             Int
  planned          Json
  completed        Json?
  fatigueScore     Float?
  performanceScore Float?
  startedAt        DateTime?
  completedAt      DateTime?
  createdAt        DateTime          @default(now())
  avgRPE           Float?
  completedStatus  Boolean           @default(false)
  exercisesCount   Int               @default(0)
  notes            String?
  totalTimeSec     Int               @default(0)
  totalTonnage     Float             @default(0)
  updatedAt        DateTime          @updatedAt
  exercises        UserExerciseLog[]
  plan             UserPlan          @relation(fields: [planId], references: [id], onDelete: Cascade)
  user             User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([planId])
  @@index([planId, week, dayNumber])
  @@index([userId, createdAt])
  @@map("user_sessions")
}

model UserExerciseLog {
  id               String      @id @default(cuid())
  sessionId        String
  exerciseId       String
  plannedSets      Int
  plannedReps      String
  plannedRpe       Float
  actualSets       Int?
  performanceScore Float?
  completed        Boolean     @default(false)
  createdAt        DateTime    @default(now())
  equipmentUsed    Json?
  notes            String?
  repsPerSet       Json?
  rpePerSet        Json?
  timeSpentSec     Int?
  weightsPerSet    Json?
  exercise         Exercise    @relation(fields: [exerciseId], references: [id])
  session          UserSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([exerciseId])
  @@index([exerciseId, createdAt])
  @@map("user_exercise_logs")
}

model UserAdaptiveState {
  id                  String   @id @default(cuid())
  userId              String
  fatigueScore        Float
  recoveryScore       Float
  performanceScore    Float
  volumeMultiplier    Float    @default(1)
  intensityMultiplier Float    @default(1)
  date                DateTime @default(now()) @db.Date
  createdAt           DateTime @default(now())
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, date])
  @@map("user_adaptive_states")
}

model UserTrainingProfile {
  id               String   @id @default(cuid())
  userId           String   @unique
  fatigueIndex     Float    @default(0)
  performanceIndex Float    @default(0)
  consistencyScore Float    @default(1.0)
  muscleProfile    Json?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_training_profiles")
}

model BlockEvaluation {
  id                 String   @id @default(cuid())
  planId             String   @unique
  completionRate     Float
  avgSessionDuration Float
  avgRpe             Float
  performanceTrend   Float
  actions            Json
  createdAt          DateTime @default(now())
  muscleMetrics      Json?
  plan               UserPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@map("block_evaluations")
}

model DailyActivity {
  id                 String   @id @default(cuid())
  userId             String
  date               DateTime @db.Date
  activeMinutes      Int      @default(0)
  workoutsCount      Int      @default(0)
  successScore       Float    @default(0)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  hourlyDistribution Json?
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@index([userId, date])
  @@map("daily_activities")
}

model MuscleVolumeHistory {
  id        String   @id @default(cuid())
  userId    String
  date      DateTime @db.Date
  muscleId  Int
  volume    Float    @default(0)
  setsCount Int      @default(0)
  createdAt DateTime @default(now())
  muscle    Muscle   @relation(fields: [muscleId], references: [id])

  @@unique([userId, date, muscleId])
  @@index([userId, date])
  @@map("muscle_volume_history")
}

model SplitTemplate {
  id          String    @id
  name        String
  type        SplitType
  daysPerWeek Int
  constraints Json
  structure   Json
  version     Int       @default(1)
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([daysPerWeek])
  @@index([type])
  @@map("split_templates")
}

model VolumeProfile {
  id              String           @id
  weeklySets      Json
  createdAt       DateTime         @default(now())
  experienceLevel ExperienceLevel
  intensityRange  Json
  priority        TrainingPriority
  repRange        Json
  goal            TrainingGoal
}

model ProgressionModel {
  id            String          @id
  name          String
  type          ProgressionType
  durationWeeks Int
  weeks         Json
  version       Int             @default(1)
  isActive      Boolean         @default(true)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  @@index([type])
  @@index([isActive])
  @@map("progression_models")
}

model Exercise {
  id                String                @id
  name              String
  instructions      String[]
  gifUrl            String?
  categoryId        Int?
  movementPatternId Int?
  rawData           Json?
  type              ExerciseType
  alternativeIds    String[]
  difficultyRpeMax  Int?
  difficultyRpeMin  Int?
  splitId           Int?
  environment       ExerciseEnvironment   @default(GYM)
  level             ExerciseLevel         @default(INTERMEDIATE)
  asAlternativeTo   ExerciseAlternative[] @relation("AlternativeToExercise")
  alternatives      ExerciseAlternative[] @relation("ExerciseToAlternative")
  equipment         ExerciseEquipment[]
  muscles           ExerciseMuscle[]
  category          Category?             @relation(fields: [categoryId], references: [id])
  movementPattern   MovementPattern?      @relation(fields: [movementPatternId], references: [id])
  split             Split?                @relation(fields: [splitId], references: [id])
  userExerciseLogs  UserExerciseLog[]

  @@map("exercises")
}

model ExerciseAlternative {
  exerciseId    String
  alternativeId String
  alternative   Exercise @relation("AlternativeToExercise", fields: [alternativeId], references: [id])
  exercise      Exercise @relation("ExerciseToAlternative", fields: [exerciseId], references: [id])

  @@id([exerciseId, alternativeId])
  @@map("exercise_alternatives")
}

model Muscle {
  id            Int                   @id @default(autoincrement())
  name          String                @unique
  exercises     ExerciseMuscle[]
  volumeHistory MuscleVolumeHistory[]

  @@map("muscles")
}

model Equipment {
  id        Int                 @id @default(autoincrement())
  name      String              @unique
  exercises ExerciseEquipment[]

  @@map("equipment")
}

model MovementPattern {
  id        Int        @id @default(autoincrement())
  name      String     @unique
  exercises Exercise[]

  @@map("movement_patterns")
}

model Category {
  id        Int        @id @default(autoincrement())
  name      String     @unique
  exercises Exercise[]

  @@map("categories")
}

model Split {
  id        Int        @id @default(autoincrement())
  name      String     @unique
  exercises Exercise[]

  @@map("splits")
}

model ExerciseMuscle {
  exerciseId           String
  muscleId             Int
  role                 MuscleRole
  activationMultiplier Float      @default(1.0)
  exercise             Exercise   @relation(fields: [exerciseId], references: [id])
  muscle               Muscle     @relation(fields: [muscleId], references: [id])

  @@id([exerciseId, muscleId, role])
  @@index([muscleId, role])
  @@map("exercise_muscles")
}

model ExerciseEquipment {
  exerciseId  String
  equipmentId Int
  equipment   Equipment @relation(fields: [equipmentId], references: [id])
  exercise    Exercise  @relation(fields: [exerciseId], references: [id])

  @@id([exerciseId, equipmentId])
  @@index([equipmentId])
  @@map("exercise_equipment")
}

enum ExerciseType {
  COMPOUND
  ISOLATION
}

enum MuscleRole {
  PRIMARY
  SECONDARY
  STABILIZER
}

enum ExerciseLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

enum DayOfWeek {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

enum ExerciseEnvironment {
  GYM
  HOME
  OUTDOOR
  ANY
}

enum SplitType {
  FULL_BODY
  PUSH_PULL_LEGS
  UPPER_LOWER
  UPPER_LOWER_FULL
  BODY_PART
  HYBRID
}

enum ProgressionType {
  LINEAR
  DOUBLE_PROGRESSION
  UNDULATING
  BLOCK
}

enum TrainingGoal {
  HYPERTROPHY
  STRENGTH
  POWERBUILDING
  FAT_LOSS
  MAINTENANCE
}

enum Gender {
  MALE
  FEMALE
  OTHER
  PREFER_NOT_TO_SAY
}

enum TrainingPriority {
  BALANCED
  GLUTE_FOCUS
}

enum ExperienceLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}
